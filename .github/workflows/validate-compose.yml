name: Validate Docker Compose

on:
  pull_request:
    paths:
      - "docker-compose.yaml"
      - ".github/workflows/**"

jobs:
  validate-compose:
    name: Validate docker-compose.yaml
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python and tools
        run: |
          python -m pip install --upgrade pip
          python -m pip install yamllint PyYAML

      - name: Run yamllint on compose file (fail on errors)
        run: |
          yamllint -c .yamllint.yml docker-compose.yaml

      - name: Validate docker-compose.yaml (default)
        # Uses the official docker/compose image to run `docker compose config` and resolve digests
        run: |
          docker run --rm -v "${{ github.workspace }}":/workdir -w /workdir docker/compose:2.17.2 config --resolve-image-digests

      - name: Validate docker-compose.yaml for service profiles
        # Detect any service-level profiles and run `docker compose config --profile <profile>` for each one
        run: |
          python - <<'PY'
import yaml,sys,subprocess
f='docker-compose.yaml'
try:
    data=yaml.safe_load(open(f)) or {}
except Exception as e:
    print('Failed to parse YAML for profile detection:', e)
    sys.exit(0)
profiles=set()
for svc in (data.get('services') or {}).values():
    p=svc.get('profiles')
    if isinstance(p,str): profiles.add(p)
    elif isinstance(p,(list,tuple)):
        for x in p:
            profiles.add(str(x))
if not profiles:
    print('No service-level profiles detected')
    sys.exit(0)
for prof in sorted(profiles):
    print('Validating compose config for profile:', prof)
    cmd=['docker','run','--rm','-v',f"${{GITHUB_WORKSPACE}}:/workdir",'-w','/workdir','docker/compose:2.17.2','config','--profile',prof]
    try:
        subprocess.check_call(cmd)
    except subprocess.CalledProcessError as e:
        print('docker compose config failed for profile',prof,'exit',e.returncode)
        sys.exit(e.returncode)
PY

  pull-images:
    name: Verify image pullability
    runs-on: ubuntu-latest
    needs: validate-compose
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      name: Validate Docker Compose

      on:
        pull_request:
          paths:
            - "docker-compose.yaml"
            - ".github/workflows/**"

      jobs:
        validate-compose:
          name: Validate docker-compose.yaml
          runs-on: ubuntu-latest

          steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Set up Python and tools
              run: |
                python -m pip install --upgrade pip
                python -m pip install yamllint PyYAML

            - name: Run yamllint on compose file (fail on errors)
              run: |
                yamllint -c .yamllint.yml docker-compose.yaml

            - name: Validate docker-compose.yaml (default)
              # Uses the official docker/compose image to run `docker compose config` and resolve digests
              run: |
                docker run --rm -v "${{ github.workspace }}":/workdir -w /workdir docker/compose:2.17.2 config --resolve-image-digests

            - name: Validate docker-compose.yaml for service profiles
              # Detect any service-level profiles and run `docker compose config --profile <profile>` for each one
              run: |
                python - <<'PY'
      import yaml,sys,subprocess
      f='docker-compose.yaml'
      try:
          data=yaml.safe_load(open(f)) or {}
      except Exception as e:
          print('Failed to parse YAML for profile detection:', e)
          sys.exit(0)
      profiles=set()
      for svc in (data.get('services') or {}).values():
          p=svc.get('profiles')
          if isinstance(p,str): profiles.add(p)
          elif isinstance(p,(list,tuple)):
              for x in p:
                  profiles.add(str(x))
      if not profiles:
          print('No service-level profiles detected')
          sys.exit(0)
      for prof in sorted(profiles):
          print('Validating compose config for profile:', prof)
          cmd=['docker','run','--rm','-v',f"${{GITHUB_WORKSPACE}}:/workdir",'-w','/workdir','docker/compose:2.17.2','config','--profile',prof]
          try:
              subprocess.check_call(cmd)
          except subprocess.CalledProcessError as e:
              print('docker compose config failed for profile',prof,'exit',e.returncode)
              sys.exit(e.returncode)
      PY

        pull-images:
          name: Verify image pullability
          runs-on: ubuntu-latest
          needs: validate-compose
          steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Pull images (quiet)
              run: |
                # Attempt to pull images referenced in docker-compose, quiet to reduce logs
                docker run --rm -v "${{ github.workspace }}":/workdir -w /workdir docker/compose:2.17.2 pull --quiet || exit 1
