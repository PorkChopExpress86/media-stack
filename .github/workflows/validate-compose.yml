name: Validate Docker Compose

on:
  workflow_dispatch:
  pull_request:
    paths:
      - "docker-compose.yaml"
      - ".github/workflows/**"

jobs:
  validate-compose:
    name: Validate docker-compose.yaml
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up environment
        run: |
          # Copy .env.example to .env and fill in required path variables with dummy values for validation
          cp .env.example .env
          # Use sed to replace empty values with dummy paths
          sed -i 's|^movies=$|movies=/tmp/movies|' .env
          sed -i 's|^other_movies=$|other_movies=/tmp/other_movies|' .env
          sed -i 's|^tv_shows=$|tv_shows=/tmp/tv_shows|' .env
          sed -i 's|^other_shows=$|other_shows=/tmp/other_shows|' .env
          sed -i 's|^kids_movies=$|kids_movies=/tmp/kids_movies|' .env
          sed -i 's|^kids_tv_shows=$|kids_tv_shows=/tmp/kids_tv_shows|' .env
          sed -i 's|^qbittorrent_downloads=$|qbittorrent_downloads=/tmp/downloads|' .env
          sed -i 's|^audiobooks=$|audiobooks=/tmp/audiobooks|' .env
          sed -i 's|^podcasts=$|podcasts=/tmp/podcasts|' .env
          sed -i 's|^pinchflat_downloads=$|pinchflat_downloads=/tmp/pinchflat|' .env
          sed -i 's|^UPLOAD_LOCATION=$|UPLOAD_LOCATION=/tmp/immich/upload|' .env
          sed -i 's|^DB_DATA_LOCATION=$|DB_DATA_LOCATION=/tmp/immich/db|' .env
          sed -i 's|^DB_PASSWORD=$|DB_PASSWORD=testpassword|' .env
          # Print .env for debugging
          echo "=== .env contents ==="
          cat .env

      - name: Set up Python and tools
        run: |
          python -m pip install --upgrade pip
          python -m pip install yamllint PyYAML

      - name: Run yamllint on compose file (fail on errors)
        run: |
          yamllint -c .yamllint.yml docker-compose.yaml

      - name: Validate docker-compose.yaml (default)
        # Uses docker compose v2 (pre-installed on GitHub runners) to validate and resolve digests
        run: |
          docker compose config --resolve-image-digests

      - name: Validate docker-compose.yaml for service profiles
        # Detect any service-level profiles and run `docker compose config --profile <profile>` for each one
        run: |
          python - <<'PY'
          import os,yaml,sys,subprocess
          f='docker-compose.yaml'
          try:
              data=yaml.safe_load(open(f)) or {}
          except Exception as e:
              print('Failed to parse YAML for profile detection:', e)
              sys.exit(0)
          profiles=set()
          for svc in (data.get('services') or {}).values():
              p=svc.get('profiles')
              if isinstance(p,str): profiles.add(p)
              elif isinstance(p,(list,tuple)):
                  for x in p:
                      profiles.add(str(x))
          if not profiles:
              print('No service-level profiles detected')
              sys.exit(0)
          workspace=os.environ.get('GITHUB_WORKSPACE','.')
          for prof in sorted(profiles):
              print('Validating compose config for profile:', prof)
              cmd=['docker','compose','config','--profile',prof]
              try:
                  subprocess.check_call(cmd)
              except subprocess.CalledProcessError as e:
                  print('docker compose config failed for profile',prof,'exit',e.returncode)
                  sys.exit(e.returncode)
          PY

  pull-images:
    name: Verify image pullability
    runs-on: ubuntu-latest
    needs: validate-compose
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Pull images (quiet)
        run: |
          # Attempt to pull images referenced in docker-compose, quiet to reduce logs
          docker compose pull --quiet || exit 1
