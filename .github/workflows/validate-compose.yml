name: Validate Docker Compose

on:
  workflow_dispatch:
  pull_request:
    paths:
      - "docker-compose.yaml"
      - ".github/workflows/**"

jobs:
  validate-compose:
    name: Validate docker-compose.yaml
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up environment
        run: |
          # Copy .env.example to .env with placeholder values to satisfy compose validation
          cp .env.example .env
          # Fill in required path variables with dummy values for validation
          echo "movies=/tmp/movies" >> .env
          echo "other_movies=/tmp/other_movies" >> .env
          echo "tv_shows=/tmp/tv_shows" >> .env
          echo "other_shows=/tmp/other_shows" >> .env
          echo "kids_movies=/tmp/kids_movies" >> .env
          echo "kids_tv_shows=/tmp/kids_tv_shows" >> .env
          echo "qbittorrent_downloads=/tmp/downloads" >> .env
          echo "audiobooks=/tmp/audiobooks" >> .env
          echo "podcasts=/tmp/podcasts" >> .env
          echo "pinchflat_downloads=/tmp/pinchflat" >> .env
          echo "UPLOAD_LOCATION=/tmp/immich/upload" >> .env
          echo "DB_DATA_LOCATION=/tmp/immich/db" >> .env
          echo "DB_PASSWORD=testpassword" >> .env

      - name: Set up Python and tools
        run: |
          python -m pip install --upgrade pip
          python -m pip install yamllint PyYAML

      - name: Run yamllint on compose file (fail on errors)
        run: |
          yamllint -c .yamllint.yml docker-compose.yaml

      - name: Validate docker-compose.yaml (default)
        # Uses docker compose v2 (pre-installed on GitHub runners) to validate and resolve digests
        run: |
          docker compose config --resolve-image-digests

      - name: Validate docker-compose.yaml for service profiles
        # Detect any service-level profiles and run `docker compose config --profile <profile>` for each one
        run: |
          python - <<'PY'
          import os,yaml,sys,subprocess
          f='docker-compose.yaml'
          try:
              data=yaml.safe_load(open(f)) or {}
          except Exception as e:
              print('Failed to parse YAML for profile detection:', e)
              sys.exit(0)
          profiles=set()
          for svc in (data.get('services') or {}).values():
              p=svc.get('profiles')
              if isinstance(p,str): profiles.add(p)
              elif isinstance(p,(list,tuple)):
                  for x in p:
                      profiles.add(str(x))
          if not profiles:
              print('No service-level profiles detected')
              sys.exit(0)
          workspace=os.environ.get('GITHUB_WORKSPACE','.')
          for prof in sorted(profiles):
              print('Validating compose config for profile:', prof)
              cmd=['docker','compose','config','--profile',prof]
              try:
                  subprocess.check_call(cmd)
              except subprocess.CalledProcessError as e:
                  print('docker compose config failed for profile',prof,'exit',e.returncode)
                  sys.exit(e.returncode)
          PY

  pull-images:
    name: Verify image pullability
    runs-on: ubuntu-latest
    needs: validate-compose
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Pull images (quiet)
        run: |
          # Attempt to pull images referenced in docker-compose, quiet to reduce logs
          docker compose pull --quiet || exit 1
